<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Talking Object Detector</title>
  <style>
    body { margin: 0; text-align: center; background: #111; color: white; font-family: sans-serif; }
    video, canvas { width: 100%; max-width: 480px; margin-top: 10px; border-radius: 12px; }
    #status { margin: 10px; font-size: 18px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
    #startBtn { background: lime; color: black; }
    #toggleBtn { background: dodgerblue; color: white; }
    #talkBtn { background: orange; color: black; }
    #micIcon { font-size: 40px; margin-top: 10px; }
    .listening { color: red; text-shadow: 0 0 10px red; }
  </style>
  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <!-- COCO-SSD model -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
</head>
<body>
  <h1>Talking Object Detector ğŸ¤–</h1>
  <button id="startBtn" onclick="enableSpeech()">Start Talking ğŸ”Š</button>
  <button id="toggleBtn" onclick="toggleMode()">Mode: Serious</button>
  <button id="talkBtn" onclick="toggleListening()">Start Conversation ğŸ¤</button>
  <div id="micIcon">ğŸ™ï¸</div>
  <video id="camera" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>
  <div id="status">Loading model...</div>

  <script>
    const video = document.getElementById('camera');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');
    const micIcon = document.getElementById('micIcon');
    let model;

    // State
    let lastSpoken = "";
    let lastSpokenTime = 0;
    const cooldown = 5000;
    let speechEnabled = false;
    let funnyMode = false;
    let listening = false;

    // Special responses for all 90 COCO-SSD classes
    const responses = {
      "person": {"hi":"Hi there, human!","hello":"Hello! Nice to meet you.","what are you":"Iâ€™m a person, just like you."},
      "bicycle": {"hi":"Ring ring! Hi, Iâ€™m a bicycle.","hello":"Hello! Letâ€™s go for a ride.","what are you":"Iâ€™m a bicycle â€” eco friendly transport!"},
      "car": {"hi":"Vroom vroom! Hi, Iâ€™m a car.","hello":"Hello! Buckle up.","what are you":"Iâ€™m a car â€” I drive fast."},
      "motorcycle": {"hi":"Brrm brrm! Hello!","hello":"Hello! Iâ€™m a motorcycle.","what are you":"Iâ€™m a motorcycle â€” two wheels, lots of fun."},
      "airplane": {"hi":"Whoosh! Hi, Iâ€™m a plane.","hello":"Hello from the sky!","what are you":"Iâ€™m an airplane â€” I fly high."},
      "bus": {"hi":"Beep beep! Iâ€™m a bus.","hello":"Hello passengers!","what are you":"Iâ€™m a bus â€” I carry lots of people."},
      "train": {"hi":"Choo choo! Hi there!","hello":"Hello from the tracks.","what are you":"Iâ€™m a train â€” all aboard!"},
      "truck": {"hi":"Honk honk! Iâ€™m a truck.","hello":"Hello, heavy hauler here!","what are you":"Iâ€™m a truck â€” I carry big loads."},
      "boat": {"hi":"Splash! Hi, Iâ€™m a boat.","hello":"Ahoy! Hello!","what are you":"Iâ€™m a boat â€” I float on water."},
      "traffic light": {"hi":"Stop! Or go! Hello!","hello":"Hello, I control traffic.","what are you":"Iâ€™m a traffic light â€” red, yellow, green."},
      "fire hydrant": {"hi":"Woosh! Hello, Iâ€™m a hydrant.","hello":"Hi! I help firefighters.","what are you":"Iâ€™m a fire hydrant â€” full of water."},
      "stop sign": {"hi":"STOP! And say hi.","hello":"Hello, I keep roads safe.","what are you":"Iâ€™m a stop sign â€” I make cars pause."},
      "parking meter": {"hi":"Ka-ching! Hi there.","hello":"Hello, insert coin please.","what are you":"Iâ€™m a parking meter â€” I time your stay."},
      "bench": {"hi":"Hi, sit with me.","hello":"Hello, Iâ€™m a bench.","what are you":"Iâ€™m a bench â€” for resting legs."},
      "bird": {"hi":"Chirp chirp! Hi!","hello":"Hello! Tweet tweet.","what are you":"Iâ€™m a bird â€” I can fly."},
      "cat": {"hi":"Meow! Hello human!","hello":"Purr... hello!","sit":"Cats donâ€™t sit on command!","what are you":"Iâ€™m a cat â€” I rule the house."},
      "dog": {"hi":"Woof! Hi friend!","hello":"Hello! Tail wagging.","sit":"Woof! Iâ€™ll sit down now.","what are you":"Iâ€™m a dog â€” manâ€™s best friend."},
      "horse": {"hi":"Neigh! Hi there.","hello":"Hello, Iâ€™m a horse.","what are you":"Iâ€™m a horse â€” ride me into the sunset."},
      "sheep": {"hi":"Baa! Hi human.","hello":"Hello! Baa baa.","what are you":"Iâ€™m a sheep â€” wooly and cute."},
      "cow": {"hi":"Moo! Hello!","hello":"Howdy, Iâ€™m a cow.","what are you":"Iâ€™m a cow â€” I give milk."},
      "elephant": {"hi":"Pawoo! Hi there.","hello":"Hello, Iâ€™m an elephant.","what are you":"Iâ€™m an elephant â€” big and wise."},
      "bear": {"hi":"Rawr! Hello human.","hello":"Hi! Iâ€™m a bear.","what are you":"Iâ€™m a bear â€” strong and furry."},
      "zebra": {"hi":"Stripey hi!","hello":"Hello, Iâ€™m a zebra.","what are you":"Iâ€™m a zebra â€” like a horse in stripes."},
      "giraffe": {"hi":"Tall hi!","hello":"Hello from up high!","what are you":"Iâ€™m a giraffe â€” I reach the trees."},
      "backpack": {"hi":"Hello, Iâ€™m a backpack.","hello":"Hi! I carry stuff.","what are you":"Iâ€™m a backpack â€” useful for school."},
      "umbrella": {"hi":"Hi, I keep you dry.","hello":"Hello! Rain or shine.","what are you":"Iâ€™m an umbrella â€” your rain shield."},
      "handbag": {"hi":"Hi, Iâ€™m stylish!","hello":"Hello, Iâ€™m a handbag.","what are you":"Iâ€™m a handbag â€” I hold secrets."},
      "tie": {"hi":"Hello, Iâ€™m formal.","hello":"Hi there, Iâ€™m a tie.","what are you":"Iâ€™m a tie â€” I make you look sharp."},
      "suitcase": {"hi":"Hi, I travel a lot.","hello":"Hello traveler!","what are you":"Iâ€™m a suitcase â€” I carry clothes."},
      "frisbee": {"hi":"Whoosh! Hello!","hello":"Hi, letâ€™s play!","what are you":"Iâ€™m a frisbee â€” throw me far."},
      "skis": {"hi":"Hi, I love snow.","hello":"Hello skier!","what are you":"Iâ€™m skis â€” slide on snow."},
      "snowboard": {"hi":"Shred hi!","hello":"Hello from the slopes.","what are you":"Iâ€™m a snowboard â€” for tricks and rides."},
      "sports ball": {"hi":"Bounce! Hi!","hello":"Hello player!","what are you":"Iâ€™m a sports ball â€” letâ€™s play."},
      "kite": {"hi":"Fly high! Hi there.","hello":"Hello from the sky.","what are you":"Iâ€™m a kite â€” I dance in the wind."},
      "baseball bat": {"hi":"Swing hi!","hello":"Hello, batter up!","what are you":"Iâ€™m a bat â€” hit home runs."},
      "baseball glove": {"hi":"Catch hi!","hello":"Hello, glove here.","what are you":"Iâ€™m a glove â€” catch the ball."},
      "skateboard": {"hi":"Roll hi!","hello":"Hello, Iâ€™m a skateboard.","what are you":"Iâ€™m a skateboard â€” kickflip time."},
      "surfboard": {"hi":"Wave hi!","hello":"Hello surfer!","what are you":"Iâ€™m a surfboard â€” I ride waves."},
      "tennis racket": {"hi":"Smash hi!","hello":"Hello, Iâ€™m a racket.","what are you":"Iâ€™m a tennis racket â€” game, set, match."},
      "bottle": {"hi":"Glug hi!","hello":"Hello, Iâ€™m a bottle.","what are you":"Iâ€™m a bottle â€” I hold drinks."},
      "wine glass": {"hi":"Cheers! Hi.","hello":"Hello, wine time.","what are you":"Iâ€™m a wine glass â€” fancy and fragile."},
      "cup": {"hi":"Sip hi!","hello":"Hello, Iâ€™m a cup.","what are you":"Iâ€™m a cup â€” I hold drinks."},
      "fork": {"hi":"Stabby hi!","hello":"Hello, Iâ€™m a fork.","what are you":"Iâ€™m a fork â€” I pick up food."},
      "knife": {"hi":"Slice hi!","hello":"Hello, careful with me.","what are you":"Iâ€™m a knife â€” I cut food."},
      "spoon": {"hi":"Scoop hi!","hello":"Hello, Iâ€™m a spoon.","what are you":"Iâ€™m a spoon â€” I scoop soup."},
      "bowl": {"hi":"Hi, I hold food.","hello":"Hello, Iâ€™m a bowl.","what are you":"Iâ€™m a bowl â€” I keep soup safe."},
      "banana": {"hi":"Peel hi!","hello":"Hello, Iâ€™m a banana.","what are you":"Iâ€™m a banana â€” full of potassium."},
      "apple": {"hi":"Crunch hi!","hello":"Hello, Iâ€™m an apple.","what are you":"Iâ€™m an apple â€” healthy and tasty."},
      "sandwich": {"hi":"Yum hi!","hello":"Hello, Iâ€™m a sandwich.","what are you":"Iâ€™m a sandwich â€” tasty layers."},
      "orange": {"hi":"Juicy hi!","hello":"Hello, Iâ€™m an orange.","what are you":"Iâ€™m an orange â€” full of vitamin C."},
      "broccoli": {"hi":"Green hi!","hello":"Hello, eat me!","what are you":"Iâ€™m broccoli â€” healthy veggie."},
      "carrot": {"hi":"Crunch hi!","hello":"Hello, Iâ€™m a carrot.","what are you":"Iâ€™m a carrot â€” good for your eyes."},
      "hot dog": {"hi":"Yummy hi!","hello":"Hello, hot dog here.","what are you":"Iâ€™m a hot dog â€” ballpark snack."},
      "pizza": {"hi":"Cheesy hi!","hello":"Hello, Iâ€™m pizza.","what are you":"Iâ€™m pizza â€” everyone loves me."},
      "donut": {"hi":"Sweet hi!","hello":"Hello, Iâ€™m a donut.","what are you":"Iâ€™m a donut â€” full of sugar."},
      "cake": {"hi":"Happy hi!","hello":"Hello, Iâ€™m cake.","what are you":"Iâ€™m cake â€” for celebrations."},
      "chair": {"hi":"Sit hi!","hello":"Hello, Iâ€™m a chair.","what are you":"Iâ€™m a chair â€” comfy and useful."},
      "couch": {"hi":"Relax hi!","hello":"Hello, Iâ€™m a couch.","what are you":"Iâ€™m a couch â€” letâ€™s chill."},
      "potted plant": {"hi":"Leafy hi!","hello":"Hello, Iâ€™m a plant.","what are you":"Iâ€™m a potted plant â€” I grow indoors."},
      "bed": {"hi":"Sleep hi!","hello":"Hello, Iâ€™m a bed.","what are you":"Iâ€™m a bed â€” time to rest."},
      "dining table": {"hi":"Meal hi!","hello":"Hello, dinner time.","what are you":"Iâ€™m a dining table â€” for eating."},
      "toilet": {"hi":"Flush hi!","hello":"Hello, bathroom buddy.","what are you":"Iâ€™m a toilet â€” I flush waste."},
      "tv": {"hi":"Screen hi!","hello":"Hello, watch me.","what are you":"Iâ€™m a TV â€” I show shows."},
      "laptop": {"hi":"Click hi!","hello":"Hello, Iâ€™m a laptop.","what are you":"Iâ€™m a laptop â€” work and play."},
      "mouse": {"hi":"Click click hi!","hello":"Hello, Iâ€™m a mouse.","what are you":"Iâ€™m a computer mouse â€” I point and click."},
      "remote": {"hi":"Click hi!","hello":"Hello, Iâ€™m a remote.","what are you":"Iâ€™m a remote â€” I control TV."},
      "keyboard": {"hi":"Type hi!","hello":"Hello, Iâ€™m a keyboard.","what are you":"Iâ€™m a keyboard â€” I type words."},
      "cell phone": {"hi":"Ring hi!","hello":"Hello, Iâ€™m a phone.","what are you":"Iâ€™m a cell phone â€” call me maybe."},
      "microwave": {"hi":"Ding hi!","hello":"Hello, Iâ€™m a microwave.","what are you":"Iâ€™m a microwave â€” I heat food."},
      "oven": {"hi":"Bake hi!","hello":"Hello, Iâ€™m an oven.","what are you":"Iâ€™m an oven â€” I cook meals."},
      "toaster": {"hi":"Pop hi!","hello":"Hello, Iâ€™m a toaster.","what are you":"Iâ€™m a toaster â€” I make toast."},
      "sink": {"hi":"Splash hi!","hello":"Hello, Iâ€™m a sink.","what are you":"Iâ€™m a sink â€” I hold water."},
      "refrigerator": {"hi":"Cool hi!","hello":"Hello, Iâ€™m a fridge.","what are you":"Iâ€™m a refrigerator â€” I keep things cold."},
      "book": {"hi":"Read hi!","hello":"Hello, Iâ€™m a book.","what are you":"Iâ€™m a book â€” I tell stories."},
      "clock": {"hi":"Tick hi!","hello":"Hello, Iâ€™m a clock.","what are you":"Iâ€™m a clock â€” I tell time."},
      "vase": {"hi":"Flower hi!","hello":"Hello, Iâ€™m a vase.","what are you":"Iâ€™m a vase â€” I hold flowers."},
      "scissors": {"hi":"Snip hi!","hello":"Hello, Iâ€™m scissors.","what are you":"Iâ€™m scissors â€” I cut things."},
      "teddy bear": {"hi":"Cuddle hi!","hello":"Hello, Iâ€™m a teddy.","what are you":"Iâ€™m a teddy bear â€” hug me."},
      "hair drier": {"hi":"Blow hi!","hello":"Hello, Iâ€™m a dryer.","what are you":"Iâ€™m a hair drier â€” I blow hot air."},
      "toothbrush": {"hi":"Brush hi!","hello":"Hello, Iâ€™m a toothbrush.","what are you":"Iâ€™m a toothbrush â€” I clean teeth."},
      "default": {"hi":"Hello there!","hello":"Hi, nice to see you!","what are you":"Iâ€™m just an object."}
    };

    // Enable speech
    function enableSpeech() {
      const msg = new SpeechSynthesisUtterance("Speech enabled");
      msg.lang = "en-US";
      window.speechSynthesis.speak(msg);
      speechEnabled = true;
      statusDiv.innerText = "Speech ready âœ…";
    }

    // Toggle mode
    function toggleMode() {
      funnyMode = !funnyMode;
      document.getElementById('toggleBtn').innerText = funnyMode ? "Mode: Funny ğŸ¤ª" : "Mode: Serious";
    }

    // Speak
    function speak(text) {
      if (!speechEnabled || !window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = "en-US";
      msg.rate = 0.9;
      window.speechSynthesis.speak(msg);
    }

    // Speech recognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = "en-US";

      recognition.onresult = (event) => {
        const userSpeech = event.results[0][0].transcript.toLowerCase();
        statusDiv.innerText = `You said: "${userSpeech}"`;

        let obj = "default";
        for (let key in responses) {
          if (lastSpoken.includes(key)) { obj = key; break; }
        }

        let reply = responses[obj][userSpeech] || responses[obj]["hi"] || responses["default"]["hi"];
        speak(reply);

        if (listening) recognition.start(); // auto restart
      };
    }

    function toggleListening() {
      if (!recognition) {
        alert("Speech recognition not supported in this browser.");
        return;
      }
      listening = !listening;
      if (listening) {
        recognition.start();
        micIcon.classList.add("listening");
        statusDiv.innerText = "ğŸ¤ Listening continuously...";
        document.getElementById('talkBtn').innerText = "Stop Conversation ğŸ›‘";
      } else {
        recognition.stop();
        micIcon.classList.remove("listening");
        statusDiv.innerText = "Stopped listening.";
        document.getElementById('talkBtn').innerText = "Start Conversation ğŸ¤";
      }
    }

    // Camera + model
    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      return new Promise(resolve => video.onloadedmetadata = () => {
        video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        resolve();
      });
    }

    async function loadModel() {
      model = await cocoSsd.load();
      statusDiv.innerText = "Model ready âœ… (tap Start Talking)";
    }

    // Detection loop
    async function detectLoop() {
      if (!model) return;
      const predictions = await model.detect(video);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      if (predictions.length > 0) {
        predictions.forEach(pred => {
          ctx.strokeStyle = "lime";
          ctx.lineWidth = 2;
          ctx.strokeRect(...pred.bbox);
          ctx.fillStyle = "lime";
          ctx.fillText(`${pred.class} (${Math.round(pred.score*100)}%)`, pred.bbox[0], pred.bbox[1] > 10 ? pred.bbox[1]-5 : 10);
        });

        const now = Date.now();
        const names = predictions.filter(p => p.score > 0.6).map(p => p.class);
        if (names.length > 0) {
          const objectsSeen = names.join(", ");
          if (objectsSeen !== lastSpoken || (now - lastSpokenTime) > cooldown) {
            speak(`I see ${objectsSeen}`);
            statusDiv.innerText = `Detected: ${objectsSeen}`;
            lastSpoken = objectsSeen;
            lastSpokenTime = now;
          }
        }
      } else {
        statusDiv.innerText = "No objects detected";
      }
      requestAnimationFrame(detectLoop);
    }

    (async () => {
      await initCamera();
      await loadModel();
      detectLoop();
    })();
  </script>
</body>
</html>
